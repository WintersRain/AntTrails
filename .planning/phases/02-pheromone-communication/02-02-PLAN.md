---
phase: 02-pheromone-communication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app.rs
  - src/systems/food.rs
autonomous: true

must_haves:
  truths:
    - "Pheromone decay runs every tick (tick%10 gate removed) with diffusion called between decay and deposit"
    - "pheromone_deposit_system receives colonies argument at its call site in app.rs"
    - "Foraging ants detect pheromone trail fringes at a lower threshold (0.01 instead of 0.1), enabling response to diffused gradients"
    - "System call order is: decay -> diffuse -> deposit (correct ordering for gradient formation)"
  artifacts:
    - path: "src/app.rs"
      provides: "Updated pheromone system call order: per-tick decay, diffusion, deposit with colonies"
      contains: "pheromone_decay_system"
    - path: "src/systems/food.rs"
      provides: "Foraging movement with lowered pheromone detection threshold"
      contains: "foraging_movement"
  key_links:
    - from: "src/app.rs::update"
      to: "src/systems/pheromone.rs::pheromone_decay_system"
      via: "Per-tick call (no tick%10 gate)"
      pattern: "pheromone_decay_system"
    - from: "src/app.rs::update"
      to: "src/systems/pheromone.rs::pheromone_deposit_system"
      via: "Updated call with colonies argument"
      pattern: "pheromone_deposit_system.*colonies"
    - from: "src/app.rs::update"
      to: "PheromoneGrid::diffuse"
      via: "New diffusion call between decay and deposit"
      pattern: "pheromones\\.diffuse"
---

<objective>
Wire the rewritten pheromone system from Plan 02-01 into the game loop: update app.rs system call order (remove tick%10 gate, add diffusion call, pass colonies to deposit), and update foraging_movement to work with the improved gradient system.

Purpose: Plan 02-01 rewrote the pheromone math but left a compile error at the app.rs call site. This plan fixes that wiring, establishes the correct system call order (decay -> diffuse -> deposit), and lowers the foraging detection threshold so ants actually respond to the newly-meaningful gradients.

NOTE â€” Gradient-following movement is already implemented: Phase 1 (Plan 01-01) wired `foraging_movement()` (food.rs) into the movement system. It already calls `follow_pheromone()` -> `get_gradient_weighted()` (after Plan 02-01's upgrade). This plan does NOT need to add gradient-following logic -- it only needs to (1) fix the app.rs call site, (2) set correct system ordering, and (3) lower the detection threshold so ants respond to the now-meaningful (non-saturated) gradients from Plan 02-01.

Output: The simulation compiles and runs with the full pheromone pipeline active. Pheromone gradients form correctly (verified by equilibrium math) but are not yet visible to the user (visualization is Plan 02-03).
</objective>

<execution_context>
@C:\Users\winte\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\winte\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pheromone-communication/02-RESEARCH.md
@.planning/phases/02-pheromone-communication/02-01-SUMMARY.md
@src/app.rs
@src/systems/food.rs
@src/systems/pheromone.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update app.rs pheromone system call order</name>
  <files>src/app.rs</files>
  <action>
  In `src/app.rs`, find the Phase 4: Pheromones section in the `update()` method (around lines 204-210). The current code is:

  ```rust
  // === Phase 4: Pheromones ===
  systems::pheromone::pheromone_deposit_system(&self.world, &mut self.pheromones);

  // Decay pheromones (every 10 ticks)
  if self.tick % 10 == 0 {
      systems::pheromone::pheromone_decay_system(&mut self.pheromones);
  }
  ```

  Replace that entire block with:

  ```rust
  // === Phase 4: Pheromones ===
  // 1. Decay first (reduces all values per-tick with type-specific rates)
  systems::pheromone::pheromone_decay_system(&mut self.pheromones);

  // 2. Diffuse (spread gradients spatially to create detectable trails)
  self.pheromones.diffuse();

  // 3. Then deposit new pheromone from ant positions (adaptive rates)
  systems::pheromone::pheromone_deposit_system(
      &self.world, &mut self.pheromones, &self.colonies,
  );
  ```

  Key changes:
  1. **Remove the `if self.tick % 10 == 0` gate** on decay. Decay now runs EVERY tick with the much higher per-type rates (0.02/0.005/0.05 vs the old 0.001).
  2. **Add `self.pheromones.diffuse()` call** between decay and deposit. This spreads pheromone to neighbors, creating detectable gradients 3-5 tiles wide around trails.
  3. **Add `&self.colonies` argument** to `pheromone_deposit_system()`. The rewritten function in 02-01 needs colonies for proximity-based home pheromone deposit.
  4. **Reorder to decay -> diffuse -> deposit.** Old code deposited THEN decayed. The correct order is: decay old pheromone, diffuse remaining, then add new deposits. This ensures fresh deposits are at full strength for the next tick's gradient calculations.

  IMPORTANT: Do NOT change any other system call order in update(). Only modify the Phase 4 block.
  </action>
  <verify>
  Run `cargo build` from the project root. The build must succeed with zero errors:
  - The `pheromone_deposit_system` argument count error from Plan 02-01 is now resolved
  - No new errors from the `diffuse()` call (it is `pub fn diffuse(&mut self)` on PheromoneGrid)
  - `cargo run` starts the simulation without panic (ants move, no crash)
  - Run the simulation for a few seconds and verify no panic from the new pheromone code paths
  </verify>
  <done>
  Pheromone system call order is decay -> diffuse -> deposit, running every tick. The tick%10 gate is removed. colonies is passed to pheromone_deposit_system. `cargo build` succeeds and `cargo run` runs without panics.
  </done>
</task>

<task type="auto">
  <name>Task 2: Lower foraging pheromone detection threshold in food.rs</name>
  <files>src/systems/food.rs</files>
  <action>
  In `src/systems/food.rs`, find the `foraging_movement()` function. In the `AntState::Wandering` arm (around line 166), there is a pheromone detection threshold:

  ```rust
  if pheromones.get(pos.x, pos.y, member.colony_id, PheromoneType::Food) > 0.1 {
      return Some(dir);
  }
  ```

  Change `0.1` to `0.01`:

  ```rust
  if pheromones.get(pos.x, pos.y, member.colony_id, PheromoneType::Food) > 0.01 {
      return Some(dir);
  }
  ```

  Why: With the old saturated system, 0.1 was reasonable because everything was near 1.0. With the new adaptive system, single-ant trails equilibrate at ~0.71 and diffused pheromone 3-5 tiles from a trail will be in the 0.01-0.1 range. A threshold of 0.1 would prevent ants from detecting trails at the diffusion fringe, defeating the purpose of diffusion. 0.01 allows ants to detect the faint gradient edge and begin following it toward the stronger trail center.

  NOTE: This threshold is the entry gate for the gradient-following logic that is ALREADY wired (Phase 1, Plan 01-01): `foraging_movement()` checks this threshold, and if met, calls `follow_pheromone()` -> `get_gradient_weighted()`. Lowering it means ants enter gradient-following mode when they reach the diffusion fringe rather than only when standing on a heavily-deposited cell.

  IMPORTANT: Do NOT change the `AntState::Carrying` arm logic. Carrying ants navigate by direct path to home, falling back to home pheromone -- that logic is correct and unrelated to this threshold.
  </action>
  <verify>
  Run `cargo build` from the project root. Must succeed with zero errors.
  Run `grep -n "0.01" src/systems/food.rs` -- should find the updated threshold line.
  Run `grep -n "0.1\b" src/systems/food.rs` -- should NOT find the old 0.1 threshold on the pheromone check line (it may appear elsewhere for unrelated purposes).
  </verify>
  <done>
  Foraging pheromone detection threshold lowered from 0.1 to 0.01 so ants detect diffused trail fringes. `cargo build` succeeds. The simulation runs with working pheromone gradients -- ants respond to trail diffusion edges.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds with zero errors
2. `cargo run` launches simulation, ants move normally, no panics (run for 10+ seconds)
3. `grep -n "tick % 10" src/app.rs` returns zero results in the pheromone section (gate removed)
4. `grep -n "diffuse" src/app.rs` returns 1 result (the new diffusion call)
5. `grep -n "pheromone_deposit_system" src/app.rs` shows colonies argument in the call
6. `grep -n "0.01" src/systems/food.rs` shows the lowered threshold
7. System call order in app.rs Phase 4 section is: decay_system -> diffuse -> deposit_system (in that order)
</verification>

<success_criteria>
- `cargo build` succeeds (the arg count error from 02-01 is resolved)
- Decay runs every tick (no tick%10 gate)
- Diffusion runs every tick between decay and deposit
- pheromone_deposit_system receives colonies for proximity-based home deposit
- Foraging detection threshold is 0.01 (not 0.1)
- Simulation runs without panics at 30 FPS
</success_criteria>

<output>
After completion, create `.planning/phases/02-pheromone-communication/02-02-SUMMARY.md`
</output>
