---
phase: 02-pheromone-communication
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/render.rs
  - src/app.rs
  - src/input.rs
autonomous: true

must_haves:
  truths:
    - "Pheromone trails are visible as colored backgrounds on terrain cells: green=food, blue=home, red=danger"
    - "Pressing 'P' toggles pheromone visualization on and off"
    - "Entity cells (ants, food, aphids) are NOT obscured by pheromone backgrounds -- entities render on top"
    - "Pheromone background intensity reflects trail strength (brighter = more traffic, dimmer = less traffic)"
    - "Active foraging trails visibly form between food sources and colony nests within 100 ticks"
  artifacts:
    - path: "src/render.rs"
      provides: "Pheromone background rendering layer between terrain and entity display"
      contains: "PheromoneGrid"
    - path: "src/app.rs"
      provides: "Pheromone toggle state and pheromones passed to render_frame"
      contains: "show_pheromones"
    - path: "src/input.rs"
      provides: "TogglePheromones command mapped to P key"
      contains: "TogglePheromones"
  key_links:
    - from: "src/render.rs::render_terrain"
      to: "src/systems/pheromone.rs::PheromoneGrid"
      via: "Reads pheromone values for background coloring"
      pattern: "pheromones\\.get"
    - from: "src/app.rs::handle_input"
      to: "show_pheromones field"
      via: "Toggle on P keypress"
      pattern: "show_pheromones"
    - from: "src/app.rs::render"
      to: "src/render.rs::render_frame"
      via: "Passes pheromones and show_pheromones to render"
      pattern: "render_frame.*pheromones"
---

<objective>
Add pheromone trail visualization as colored background cells in the terminal renderer, with a toggle key ('P') to show/hide the pheromone overlay.

Purpose: The success criteria for Phase 2 require "visible trails form between food sources and colony nests." Without visualization, the user cannot see whether the pheromone system is working. This plan adds the visual feedback layer that makes pheromone behavior observable.

Output: Colored pheromone trails visible in the terminal (green=food, blue=home, red=danger), toggled with 'P', intensity mapped to pheromone strength. Entities always render on top of pheromone backgrounds.
</objective>

<execution_context>
@C:\Users\winte\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\winte\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pheromone-communication/02-RESEARCH.md
@.planning/phases/02-pheromone-communication/02-01-SUMMARY.md
@.planning/phases/02-pheromone-communication/02-02-SUMMARY.md
@src/render.rs
@src/app.rs
@src/input.rs
@src/systems/pheromone.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pheromone toggle command and state</name>
  <files>src/input.rs, src/app.rs</files>
  <action>
  **In `src/input.rs`:**

  1. Add `TogglePheromones` variant to the `Command` enum:
     ```rust
     pub enum Command {
         Quit,
         Pause,
         SpeedUp,
         SpeedDown,
         ScrollUp,
         ScrollDown,
         ScrollLeft,
         ScrollRight,
         TogglePheromones,  // NEW
     }
     ```

  2. Add the key mapping in `Command::from_key()`. Add this arm before the `_ => None` catch-all:
     ```rust
     KeyCode::Char('p') | KeyCode::Char('P') => Some(Command::TogglePheromones),
     ```

     NOTE: 'P' is currently unused (not mapped to any command). The 'p' lowercase is also unused. This will not conflict with existing bindings.

  **In `src/app.rs`:**

  3. Add `show_pheromones: bool` field to the `App` struct:
     ```rust
     pub struct App {
         // ... existing fields ...
         show_pheromones: bool,  // NEW: toggle with 'P' key
     }
     ```

  4. Initialize `show_pheromones: true` in `App::new()` (inside the `Ok(Self { ... })` block). Default to ON so the user sees trails immediately -- this is the core visual feedback of Phase 2.

  5. Add the toggle handler in `handle_input()`. Add this arm to the match:
     ```rust
     Some(Command::TogglePheromones) => {
         self.show_pheromones = !self.show_pheromones;
     }
     ```

  6. Update the render call to pass pheromone data. In the `render()` method, change:
     ```rust
     self.terminal.draw(|frame| {
         render_frame(
             frame, terrain, water, world, colonies, camera, tick, paused, speed, raining,
         );
     })?;
     ```

     To:
     ```rust
     let pheromones = &self.pheromones;
     let show_pheromones = self.show_pheromones;

     self.terminal.draw(|frame| {
         render_frame(
             frame, terrain, water, world, colonies, camera, tick, paused, speed, raining,
             pheromones, show_pheromones,
         );
     })?;
     ```

  7. Add 'P' to the controls display in render_stats (this is in render.rs but noted here for completeness -- it will be done in Task 2).
  </action>
  <verify>
  Run `cargo check 2>&1`. Expect a compilation error in render.rs because `render_frame` now receives 2 extra arguments but its signature has not been updated yet. Confirm:
  - The ONLY error is the `render_frame` argument count mismatch
  - No errors in input.rs (TogglePheromones variant and key mapping compile)
  - No errors in app.rs struct definition or handle_input
  </verify>
  <done>
  'P' key mapped to TogglePheromones command. App has `show_pheromones` field (default true). Toggle handler wired. Pheromones and show_pheromones passed to render_frame. Only error is render_frame signature mismatch (fixed in Task 2).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pheromone background rendering layer to render.rs</name>
  <files>src/render.rs</files>
  <action>
  **Update imports** at the top of render.rs. Add:
  ```rust
  use crate::systems::pheromone::{PheromoneGrid, PheromoneType};
  ```

  **Update `render_frame()` signature** to accept pheromone data:
  ```rust
  pub fn render_frame(
      frame: &mut Frame,
      terrain: &Terrain,
      water: &WaterGrid,
      world: &World,
      colonies: &[ColonyState],
      camera: &Camera,
      tick: u64,
      paused: bool,
      speed: f32,
      raining: bool,
      pheromones: &PheromoneGrid,    // NEW
      show_pheromones: bool,          // NEW
  ) {
  ```

  **Update the `render_terrain()` call** inside `render_frame()` to pass the new parameters:
  ```rust
  render_terrain(frame, chunks[0], terrain, water, world, camera, pheromones, show_pheromones);
  ```

  **Update `render_terrain()` signature:**
  ```rust
  fn render_terrain(
      frame: &mut Frame,
      area: Rect,
      terrain: &Terrain,
      water: &WaterGrid,
      world: &World,
      camera: &Camera,
      pheromones: &PheromoneGrid,    // NEW
      show_pheromones: bool,          // NEW
  ) {
  ```

  **Add pheromone background rendering.** In the `render_terrain()` function, find the terrain rendering section (the final `else` block in the `for dy in 0..view_height` loop, around lines 122-142). Currently:

  ```rust
  // Render terrain
  let (ch, color) = match terrain.get(world_x, world_y) {
      Some(TerrainType::Air) => (' ', Color::Reset),
      Some(TerrainType::Tunnel) => ('·', Color::Rgb(80, 60, 40)),
      Some(TerrainType::Soil) => ('░', Color::Rgb(139, 90, 43)),
      Some(TerrainType::SoilDense) => ('▒', Color::Rgb(101, 67, 33)),
      Some(TerrainType::Rock) => ('█', Color::DarkGray),
      Some(TerrainType::Surface) => ('▀', Color::Green),
      None => (' ', Color::Reset),
  };

  let x = inner.x + dx as u16;
  let y = inner.y + dy as u16;

  if x < inner.x + inner.width && y < inner.y + inner.height {
      frame
          .buffer_mut()
          .set_string(x, y, ch.to_string(), Style::default().fg(color));
  }
  ```

  Replace that entire terrain rendering section with:

  ```rust
  // Render terrain
  let (ch, color) = match terrain.get(world_x, world_y) {
      Some(TerrainType::Air) => (' ', Color::Reset),
      Some(TerrainType::Tunnel) => ('·', Color::Rgb(80, 60, 40)),
      Some(TerrainType::Soil) => ('░', Color::Rgb(139, 90, 43)),
      Some(TerrainType::SoilDense) => ('▒', Color::Rgb(101, 67, 33)),
      Some(TerrainType::Rock) => ('█', Color::DarkGray),
      Some(TerrainType::Surface) => ('▀', Color::Green),
      None => (' ', Color::Reset),
  };

  let x = inner.x + dx as u16;
  let y = inner.y + dy as u16;

  if x < inner.x + inner.width && y < inner.y + inner.height {
      // Add pheromone background layer if enabled
      let style = if show_pheromones {
          let mut bg_r: u8 = 0;
          let mut bg_g: u8 = 0;
          let mut bg_b: u8 = 0;

          for c in 0..pheromones.max_colonies as u8 {
              let food_val = pheromones.get(world_x, world_y, c, PheromoneType::Food);
              let home_val = pheromones.get(world_x, world_y, c, PheromoneType::Home);
              let danger_val = pheromones.get(world_x, world_y, c, PheromoneType::Danger);

              // Map intensity (0.0-1.0) to color (0-120)
              // Cap at 120 to preserve foreground character visibility
              if food_val > 0.05 {
                  bg_g = bg_g.max((food_val.clamp(0.0, 1.0) * 120.0) as u8);
              }
              if home_val > 0.05 {
                  bg_b = bg_b.max((home_val.clamp(0.0, 1.0) * 120.0) as u8);
              }
              if danger_val > 0.05 {
                  bg_r = bg_r.max((danger_val.clamp(0.0, 1.0) * 120.0) as u8);
              }
          }

          if bg_r > 0 || bg_g > 0 || bg_b > 0 {
              Style::default().fg(color).bg(Color::Rgb(bg_r, bg_g, bg_b))
          } else {
              Style::default().fg(color)
          }
      } else {
          Style::default().fg(color)
      };

      frame
          .buffer_mut()
          .set_string(x, y, ch.to_string(), style);
  }
  ```

  **CRITICAL rendering order:** Entity cells (ants, food, aphids, water) are rendered BEFORE the terrain section via `continue` statements. They will NOT have pheromone backgrounds applied. This is correct -- entities should not be obscured by pheromone coloring. Only terrain/tunnel/air cells get pheromone backgrounds.

  **Add 'P' to the controls legend in `render_stats()`:**

  Find the controls section (around line 240-244):
  ```rust
  Line::styled("─ Controls ─", Style::default().fg(Color::Cyan)),
  Line::raw("[Space] Pause/Resume"),
  Line::raw("[+/-]   Speed up/down"),
  Line::raw("[Arrows] Scroll"),
  Line::raw("[Q]     Quit"),
  ```

  Add after the `[Arrows] Scroll` line:
  ```rust
  Line::raw("[P]     Pheromones"),
  ```

  So it becomes:
  ```rust
  Line::styled("─ Controls ─", Style::default().fg(Color::Cyan)),
  Line::raw("[Space] Pause/Resume"),
  Line::raw("[+/-]   Speed up/down"),
  Line::raw("[Arrows] Scroll"),
  Line::raw("[P]     Pheromones"),
  Line::raw("[Q]     Quit"),
  ```
  </action>
  <verify>
  Run `cargo build` from the project root. Must succeed with zero errors.
  Run `cargo run` and verify:
  1. Simulation starts and renders correctly
  2. After 50-100 ticks, colored backgrounds appear on terrain cells (green near food sources, blue near colony nests)
  3. Pressing 'P' toggles the pheromone overlay on and off
  4. Entity characters (ants, food symbols) are clearly visible and not obscured by pheromone colors
  5. Pheromone colors are dim (max 120 intensity out of 255) -- readable, not eye-searing
  6. The controls legend shows "[P] Pheromones"
  </verify>
  <done>
  Pheromone trails render as colored backgrounds (green=food, blue=home, red=danger) on terrain cells. Intensity reflects pheromone strength (brighter = more traffic). Entities render on top without pheromone backgrounds. 'P' toggles visualization. Controls legend updated. `cargo build` succeeds and visual trails are observable.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds with zero errors
2. `cargo run` shows colored pheromone trails forming near food sources (green) and colony nests (blue)
3. Pressing 'P' toggles pheromone visualization on/off
4. Ants (•, *, Q, etc.) are always clearly visible against pheromone backgrounds
5. `grep -n "PheromoneGrid\|PheromoneType" src/render.rs` returns import and usage lines
6. `grep -n "show_pheromones" src/app.rs` returns field, init, toggle, and render-pass lines
7. `grep -n "TogglePheromones" src/input.rs` returns enum variant and key mapping lines
8. After 200+ ticks, green trails are visible between food sources and active foraging ants
9. Blue pheromone is concentrated near colony nests (not uniformly spread across the map)
10. Danger pheromone (red) appears briefly during combat events and fades within seconds
</verification>

<success_criteria>
- Pheromone trails are visible as colored backgrounds: green=food, blue=home, red=danger
- Trail intensity reflects pheromone strength (dim for weak, bright for strong, capped at 120 RGB)
- Entities render on top of pheromone backgrounds (not obscured)
- 'P' toggles pheromone visualization on/off (default: on)
- Green food trails form between food sources and foraging ant paths
- Blue home trails concentrate near colony nests (not everywhere)
- The simulation maintains responsive frame rate with visualization active
</success_criteria>

<output>
After completion, create `.planning/phases/02-pheromone-communication/02-03-SUMMARY.md`
</output>
