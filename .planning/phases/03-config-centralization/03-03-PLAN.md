---
phase: 03-config-centralization
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/systems/food.rs
  - src/systems/spawn.rs
  - src/systems/aphid.rs
  - src/systems/water.rs
  - src/systems/hazard.rs
  - src/colony.rs
autonomous: true

must_haves:
  truths:
    - "Food amounts, regrow rates, and pickup/deposit values come from config.food, not local constants"
    - "Spawn counts, colony distances, and aphid values come from config.spawn, not local constants"
    - "Water thresholds, rain parameters, and drown values come from config.water, not local constants"
    - "Hazard collapse chances and stability values come from config.hazard, not local constants"
    - "Colony initial food comes from config.colony, not a hardcoded 100"
    - "No const declarations remain in these 6 files for behavioral values"
  artifacts:
    - path: "src/systems/food.rs"
      provides: "Food system using config values"
      contains: "config.food"
    - path: "src/systems/water.rs"
      provides: "Water system using config values"
      contains: "config.water"
    - path: "src/systems/hazard.rs"
      provides: "Hazard system using config values"
      contains: "config.hazard"
    - path: "src/colony.rs"
      provides: "Colony init using config value"
      contains: "initial_food"
  key_links:
    - from: "src/systems/food.rs"
      to: "src/config.rs"
      via: "config.food.* field access"
      pattern: "config\\.food\\."
    - from: "src/systems/water.rs"
      to: "src/config.rs"
      via: "config.water.* field access"
      pattern: "config\\.water\\."
    - from: "src/colony.rs"
      to: "initial_food parameter"
      via: "ColonyState::new takes initial_food param"
      pattern: "initial_food"
---

<objective>
Replace all named constants and inline magic numbers in the environment/resource systems (food, spawn, aphid, water, hazard) and colony.rs with config struct field access. Remove old const declarations.

Purpose: Completes the config centralization. After this plan, every behavioral constant in the entire codebase reads from SimConfig.
Output: 6 modified files with zero local behavioral constants remaining. Phase 3 complete.
</objective>

<execution_context>
@C:\Users\winte\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\winte\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@E:\VS Code Projects\AntTrails\.planning\PROJECT.md
@E:\VS Code Projects\AntTrails\.planning\ROADMAP.md
@E:\VS Code Projects\AntTrails\.planning\STATE.md
@E:\VS Code Projects\AntTrails\.planning\phases\03-config-centralization\03-RESEARCH.md
@E:\VS Code Projects\AntTrails\.planning\phases\03-config-centralization\03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace constants in food.rs, spawn.rs, and aphid.rs</name>
  <files>src/systems/food.rs, src/systems/spawn.rs, src/systems/aphid.rs</files>
  <action>
Read 03-RESEARCH.md for the exact constant-to-field mapping.

**food.rs:**

Rename `_config` to `config` in all function signatures (foraging_system, check_deposit, food_regrow_system). Also update spawn_food_sources to accept `&SimConfig` if it uses constants (it receives num_food_sources from app.rs already, but check for INITIAL_FOOD_AMOUNT usage).

1. Remove named constants: `FOOD_REGROW_INTERVAL`, `INITIAL_FOOD_AMOUNT`

2. Replace with config:
   - `FOOD_REGROW_INTERVAL` -> `config.food.regrow_interval`
   - `INITIAL_FOOD_AMOUNT` -> `config.food.initial_amount`

3. Replace inline magic numbers:
   - `1` food regrow rate -> `config.food.regrow_rate`
   - `3` deposit distance (appears twice at lines ~102 and ~231) -> `config.food.deposit_distance`
   - `10` food per deposit -> `config.food.food_per_deposit`
   - `10` food per pickup (CarryItem::Food(10)) -> `config.food.food_per_pickup`
   - `0.01` food pheromone threshold -> `config.food.food_pheromone_threshold`

4. For spawn_food_sources: it's called from app.rs with num_food_sources already passed as a parameter. If it also uses INITIAL_FOOD_AMOUNT internally, add `config: &SimConfig` parameter and pass from app.rs. Alternatively, pass just the initial_amount value as a parameter to keep it simple.

5. Thread config to any internal helper functions that need values.

**spawn.rs:**

1. Remove named constants: `INITIAL_WORKERS`, `MIN_COLONY_DISTANCE`

2. Replace with config:
   - `INITIAL_WORKERS` -> access via config parameter
   - `MIN_COLONY_DISTANCE` -> access via config parameter

3. spawn_colonies is called from app.rs. It currently receives `num_colonies` as a parameter. Update its signature to accept `&SimConfig` (or `&SpawnConfig`) so it can also read initial_workers and min_colony_distance from config.

4. Update the app.rs call site for spawn_colonies: change from passing just num_colonies to passing &self.config (the function reads config.spawn.num_colonies, config.spawn.initial_workers, config.spawn.min_colony_distance internally).

5. Ensure `use crate::config::SimConfig;` is imported.

**aphid.rs:**

Rename `_config` to `config` in aphid_system signature.

1. Remove named constants: `APHID_FOOD_RATE`, `CLAIM_TICKS`, `NEARBY_DISTANCE`

2. Replace with config:
   - `APHID_FOOD_RATE` -> `config.spawn.aphid_food_rate`
   - `CLAIM_TICKS` -> `config.spawn.aphid_claim_ticks`
   - `NEARBY_DISTANCE` -> `config.spawn.aphid_nearby_distance`

3. For spawn_aphids: it's called from app.rs with num_aphids already passed. Check if it uses any other constants internally. If not, leave its signature as-is.

4. Ensure `use crate::config::SimConfig;` is imported.

CRITICAL: Do NOT change any numeric value. Behavior must remain identical.
  </action>
  <verify>
Run `cargo build` -- must compile cleanly.
Run `grep -c "const " src/systems/food.rs src/systems/spawn.rs src/systems/aphid.rs` -- should show 0 behavioral const declarations.
  </verify>
  <done>food.rs, spawn.rs, and aphid.rs have zero behavioral constants. All values read from config. cargo build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Replace constants in water.rs, hazard.rs, and colony.rs</name>
  <files>src/systems/water.rs, src/systems/hazard.rs, src/colony.rs, src/app.rs</files>
  <action>
Read 03-RESEARCH.md for the exact constant-to-field mapping.

**water.rs:**

Rename `_config` to `config` in all function signatures (evaporation_system, rain_system, drowning_system, flee_flood_system).

1. Remove named constant: `MAX_WATER_DEPTH`

2. Replace with config:
   - `MAX_WATER_DEPTH` -> `config.water.max_depth`

3. Replace inline magic numbers:
   - `6` passable threshold -> `config.water.passable_threshold`
   - `4` dangerous threshold -> `config.water.dangerous_threshold`
   - `2` evaporation max depth -> `config.water.evaporation_max_depth`
   - `500` stagnant evaporation ticks -> `config.water.stagnant_evaporation_ticks`
   - `10000` rain chance -> `config.water.rain_chance`
   - `1..=3` rain intensity -> `config.water.rain_intensity_min..=config.water.rain_intensity_max`
   - `200..1000` rain duration -> `config.water.rain_duration_min..config.water.rain_duration_max`
   - `0.5, 0.3` rain coverage formula -> use `config.water.rain_coverage_min` and `config.water.rain_coverage_max` to reconstruct: `rand * (max - min) + min`
   - `1, 3, 10, 30` drown thresholds by depth -> `config.water.drown_threshold_7`, `drown_threshold_6`, `drown_threshold_5`, `drown_threshold_4`
   - `999` (instant death at depth 7) -> can remain hardcoded as it's a sentinel value, OR add to config
   - `2` flee flood depth -> `config.water.flee_flood_depth`
   - `4` depth in drowning (same as dangerous_threshold) -> `config.water.dangerous_threshold`

4. Note: WaterCell methods (is_passable, is_dangerous, movement_penalty) use thresholds too. Per research recommendation, the system-level functions should use config values. For WaterCell methods: either pass config values as parameters to these methods, or if they're only called from system functions that have config, convert the checks to use config at the call site. Choose the simplest approach that keeps the code clean.

5. Functions that DON'T need config changes: calculate_pressure, water_flow_system (these are physics, not behavioral). Their signatures should remain unchanged from Plan 01.

**hazard.rs:**

Rename `_config` to `config` in cave_in_system signature.

1. Replace inline magic numbers:
   - `2, 0` dense stability bonus -> `config.hazard.dense_stability_bonus` (the 0 is the "no bonus" case, keep as 0)
   - `0, 1, 3, 10, 25` collapse chances by neighbor count -> `config.hazard.collapse_chance_3`, `collapse_chance_4`, `collapse_chance_5`, `collapse_chance_6plus` (0 for <=2 neighbors stays as 0, it means "never collapse")

2. Ensure `use crate::config::SimConfig;` is imported.

**colony.rs:**

1. `ColonyState::new()` currently hardcodes `food_stored: 100`. Change the method signature to accept an `initial_food: u32` parameter: `pub fn new(x: i32, y: i32, initial_food: u32) -> Self`
   - Replace `100` with `initial_food` in the body

2. Update the call site in spawn.rs where ColonyState::new is called: pass `config.colony.initial_food`.

3. This is a minimal change -- colony.rs doesn't need to import SimConfig, it just receives the value.

**app.rs (minor update):**

If spawn_colonies signature changed (now takes &SimConfig), update the call in App::new():
- Old: `systems::spawn::spawn_colonies(&mut world, &terrain, config.spawn.num_colonies)`
- New: `systems::spawn::spawn_colonies(&mut world, &terrain, &config)`

Similarly for spawn_food_sources if its signature changed.

CRITICAL: Do NOT change any numeric value. Behavior must remain identical.
  </action>
  <verify>
Run `cargo build` -- must compile cleanly with zero errors.
Run `cargo clippy` -- no new warnings.
Run `grep -rn "^const\|^pub const" src/systems/ src/colony.rs` -- only non-behavioral constants should remain (if any).
Run the simulation (`cargo run`) for 5+ seconds, observe ants moving, foraging, fighting, digging -- all behavior identical to before Phase 3.
  </verify>
  <done>water.rs, hazard.rs, colony.rs have zero behavioral constants. All spawn functions use config. Every behavioral constant in the entire codebase now reads from SimConfig. cargo build passes. Phase 3 complete.</done>
</task>

</tasks>

<verification>
1. `cargo build` passes with zero errors
2. `cargo clippy` produces no config-related warnings
3. Full constant audit: `grep -rn "^const\|^pub const" src/systems/ src/colony.rs src/app.rs` shows only TARGET_FPS, FRAME_DURATION, and any non-behavioral constants (terrain/render/structural)
4. Config coverage: `grep -rc "config\." src/systems/` shows config access in every system file
5. Running simulation: ants move, forage, fight, dig, lay pheromones -- identical to pre-Phase-3 behavior
6. Single source of truth: changing a value in config.rs Default would be the ONLY place needed to affect that behavior
</verification>

<success_criteria>
- Zero behavioral const declarations in any system file
- All behavioral values accessed through config.{subsystem}.{field}
- ColonyState::new accepts initial_food parameter
- spawn_colonies uses config for all spawn parameters
- cargo build compiles cleanly
- Simulation behavior unchanged -- same values, just organized
- Requirement POL-01 satisfied: all magic constants centralized in SimConfig
</success_criteria>

<output>
After completion, create `.planning/phases/03-config-centralization/03-03-SUMMARY.md`
</output>
