---
phase: 03-config-centralization
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/systems/pheromone.rs
  - src/systems/combat.rs
  - src/systems/lifecycle.rs
  - src/systems/movement.rs
  - src/systems/dig.rs
autonomous: true

must_haves:
  truths:
    - "Pheromone decay rates, deposit amounts, and thresholds come from config.pheromone, not local constants"
    - "Combat damage, strength values, and danger thresholds come from config.combat, not local constants"
    - "Lifecycle timers and food costs come from config.lifecycle, not local constants"
    - "Movement probability thresholds come from config.movement, not local constants"
    - "No const declarations remain in these 5 system files for behavioral values"
  artifacts:
    - path: "src/systems/pheromone.rs"
      provides: "Pheromone system using config values"
      contains: "config.pheromone"
    - path: "src/systems/combat.rs"
      provides: "Combat system using config values"
      contains: "config.combat"
    - path: "src/systems/lifecycle.rs"
      provides: "Lifecycle system using config values"
      contains: "config.lifecycle"
    - path: "src/systems/movement.rs"
      provides: "Movement system using config values"
      contains: "config.movement"
    - path: "src/systems/dig.rs"
      provides: "Dig system using config values"
      contains: "config.movement"
  key_links:
    - from: "src/systems/pheromone.rs"
      to: "src/config.rs"
      via: "config.pheromone.* field access"
      pattern: "config\\.(pheromone|combat)\\."
    - from: "src/systems/combat.rs"
      to: "src/config.rs"
      via: "config.combat.* field access"
      pattern: "config\\.combat\\."
---

<objective>
Replace all named constants and inline magic numbers in the core behavior systems (pheromone, combat, lifecycle, movement, dig) with config struct field access. Remove the old const declarations.

Purpose: These 5 files contain the majority of behavioral constants (~50 of the ~70 total). After this plan, the core ant behavior loop reads from config.
Output: 5 modified system files with zero local behavioral constants remaining.
</objective>

<execution_context>
@C:\Users\winte\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\winte\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@E:\VS Code Projects\AntTrails\.planning\PROJECT.md
@E:\VS Code Projects\AntTrails\.planning\ROADMAP.md
@E:\VS Code Projects\AntTrails\.planning\STATE.md
@E:\VS Code Projects\AntTrails\.planning\phases\03-config-centralization\03-RESEARCH.md
@E:\VS Code Projects\AntTrails\.planning\phases\03-config-centralization\03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace constants in pheromone.rs and combat.rs</name>
  <files>src/systems/pheromone.rs, src/systems/combat.rs</files>
  <action>
Read 03-RESEARCH.md for the exact constant-to-field mapping.

**pheromone.rs:**

Rename `_config` to `config` in all function signatures that use it.

1. Remove ALL named constants: `MAX_PHEROMONE`, `DECAY_FOOD`, `DECAY_HOME`, `DECAY_DANGER`, `SNAP_TO_ZERO`, `DEPOSIT_FOOD_BASE`, `DEPOSIT_HOME_BASE`, `DEPOSIT_DANGER_BASE`, `DIFFUSION_RATE`, `HOME_DEPOSIT_RADIUS`

2. For system-level functions (pheromone_decay_system, pheromone_deposit_system): these receive `config: &SimConfig`. Replace constant references:
   - `MAX_PHEROMONE` -> `config.pheromone.max_strength`
   - `DEPOSIT_FOOD_BASE` -> `config.pheromone.deposit_food`
   - `DEPOSIT_HOME_BASE` -> `config.pheromone.deposit_home`
   - `DEPOSIT_DANGER_BASE` -> `config.pheromone.deposit_danger`
   - `HOME_DEPOSIT_RADIUS` -> `config.pheromone.home_deposit_radius`

3. For PheromoneGrid methods that need config:
   - `decay_all()` -> `decay_all(&mut self, config: &PheromoneConfig)`:
     - `DECAY_FOOD` -> `config.decay_food`
     - `DECAY_HOME` -> `config.decay_home`
     - `DECAY_DANGER` -> `config.decay_danger`
     - `SNAP_TO_ZERO` -> `config.snap_to_zero`
   - `diffuse()` -> already has `_config: &PheromoneConfig` from Plan 01, rename to `config`:
     - `DIFFUSION_RATE` -> `config.diffusion_rate`
     - Leave cardinal_weight/diagonal_weight as-is (these are [LEAVE] per research)

4. For `pheromone_decay_system`: it calls `pheromones.decay_all()`. Update to `pheromones.decay_all(&config.pheromone)`.

5. Replace inline magic numbers:
   - `0.01` gradient threshold (in get_gradient_weighted) -> `config.pheromone.gradient_threshold` -- BUT this function doesn't receive config. It's called from movement.rs. Add `gradient_threshold: f32` parameter to `get_gradient_weighted()` and pass `config.pheromone.gradient_threshold` from the movement.rs call site. (movement.rs already has &SimConfig from Plan 01.)
   - `20.0` dig deposit radius -> `config.pheromone.dig_deposit_radius`
   - `0.5` dig deposit multiplier -> `config.pheromone.dig_deposit_multiplier`

6. Ensure `use crate::config::{SimConfig, PheromoneConfig};` is at the top.

**combat.rs:**

Rename `_config` to `config` in all function signatures (combat_system, soldier_ai_system, flee_system).

1. Remove named constants: `BASE_DAMAGE`, `COMBAT_INTERVAL`

2. Replace in combat_system:
   - `COMBAT_INTERVAL` -> `config.combat.combat_interval`
   - `BASE_DAMAGE` -> `config.combat.base_damage`

3. Replace inline magic numbers (use research inventory for exact locations):
   - Soldier/worker/other strength (30, 10, 5) -> `config.combat.soldier_strength`, `config.combat.worker_strength`, `config.combat.other_strength`
   - `0.5` danger deposit -> `config.combat.danger_deposit_amount`
   - `10` random damage range -> `config.combat.damage_random_range`
   - `50` default health -> `config.combat.default_health`
   - `10` default fighter strength -> `config.combat.default_fighter_strength`
   - `0.1` fight danger threshold -> `config.combat.fight_danger_threshold`
   - `0.05` stop fight threshold -> `config.combat.stop_fight_threshold`
   - `0.3` flee danger threshold -> `config.combat.flee_danger_threshold`
   - `0.1` stop flee threshold -> `config.combat.stop_flee_threshold`
   - `6` max colonies scan -> `config.combat.max_colonies_scan`

4. For helper functions called from combat_system/soldier_ai_system/flee_system: if they use magic numbers, either inline the logic or pass config down. Thread `&SimConfig` or `&CombatConfig` into internal helpers as needed.

5. Ensure `use crate::config::SimConfig;` is at the top.

CRITICAL: Do NOT change any numeric value. The config default values are EXACTLY the same as the old constants. This is purely mechanical replacement.
  </action>
  <verify>
Run `cargo build` -- must compile cleanly.
Run `grep -c "const " src/systems/pheromone.rs src/systems/combat.rs` -- should show 0 behavioral const declarations (only non-behavioral consts if any remain).
Run the simulation for a few seconds -- behavior identical.
  </verify>
  <done>pheromone.rs and combat.rs have zero behavioral constants. All values read from config. cargo build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Replace constants in lifecycle.rs, movement.rs, and dig.rs</name>
  <files>src/systems/lifecycle.rs, src/systems/movement.rs, src/systems/dig.rs</files>
  <action>
Read 03-RESEARCH.md for the exact constant-to-field mapping.

**lifecycle.rs:**

Rename `_config` to `config` in lifecycle_system signature.

1. Remove ALL named constants: `EGG_HATCH_TIME`, `LARVAE_MATURE_TIME`, `QUEEN_LAY_INTERVAL`, `FOOD_PER_EGG`, `WORKER_LIFESPAN`, `SOLDIER_LIFESPAN`, `QUEEN_LIFESPAN`, `FOOD_CONSUME_INTERVAL`, `LARVAE_FOOD_COST`, `ANT_FOOD_COST`

2. Replace each with `config.lifecycle.*`:
   - `EGG_HATCH_TIME` -> `config.lifecycle.egg_hatch_time`
   - `LARVAE_MATURE_TIME` -> `config.lifecycle.larvae_mature_time`
   - `QUEEN_LAY_INTERVAL` -> `config.lifecycle.queen_lay_interval`
   - `FOOD_PER_EGG` -> `config.lifecycle.food_per_egg`
   - `WORKER_LIFESPAN` -> `config.lifecycle.worker_lifespan`
   - `SOLDIER_LIFESPAN` -> `config.lifecycle.soldier_lifespan`
   - `QUEEN_LIFESPAN` -> `config.lifecycle.queen_lifespan`
   - `FOOD_CONSUME_INTERVAL` -> `config.lifecycle.food_consume_interval`
   - `LARVAE_FOOD_COST` -> `config.lifecycle.larvae_food_cost`
   - `ANT_FOOD_COST` -> `config.lifecycle.ant_food_cost`

3. Replace inline magic number:
   - `204` worker ratio threshold -> `config.lifecycle.worker_ratio_threshold`

4. If lifecycle_system calls internal helper functions that use these constants, thread config through to them.

**movement.rs:**

Rename `_config` to `config` in movement_system signature.

1. Replace inline magic numbers:
   - `5` queen move threshold -> `config.movement.queen_move_threshold`
   - `90` idle move threshold -> `config.movement.idle_move_threshold`

2. Update the call to `pheromones.get_gradient_weighted()` (if modified in Task 1 to accept gradient_threshold param): pass `config.pheromone.gradient_threshold`.

3. No named constants to remove (movement.rs only has inline magic numbers).

**dig.rs:**

Rename `_config` to `config` in dig_ai_system and dig_system signatures.

1. Remove named constants: `DIG_CHANCE`, `REINFORCE_CHANCE`

2. Replace with config:
   - `DIG_CHANCE` -> `config.movement.dig_chance`
   - `REINFORCE_CHANCE` -> `config.movement.reinforce_chance`

3. Replace inline magic numbers:
   - `50` start dig chance -> `config.movement.start_dig_chance`
   - `15` underground return chance -> `config.movement.underground_return_chance`
   - `3` surface return chance -> `config.movement.surface_return_chance`
   - `30` dig distraction chance -> `config.movement.dig_distraction_chance`
   - `5` idle to wander chance -> `config.movement.idle_to_wander_chance_dig`

4. All dig behavior constants are under MovementConfig since they control movement/state-transition probabilities.

5. Ensure `use crate::config::SimConfig;` is imported in each file.

CRITICAL: Do NOT change any numeric value. Behavior must remain identical.
  </action>
  <verify>
Run `cargo build` -- must compile cleanly.
Run `grep -c "const " src/systems/lifecycle.rs src/systems/dig.rs` -- should show 0 behavioral const declarations.
Run the simulation briefly -- ants behave identically.
  </verify>
  <done>lifecycle.rs, movement.rs, and dig.rs have zero behavioral constants. All values read from config. cargo build passes.</done>
</task>

</tasks>

<verification>
1. `cargo build` passes with zero errors
2. `grep -rn "^const\|^pub const" src/systems/pheromone.rs src/systems/combat.rs src/systems/lifecycle.rs src/systems/movement.rs src/systems/dig.rs` returns no behavioral constant declarations
3. `grep -c "config\." src/systems/pheromone.rs` shows multiple config accesses
4. `grep -c "config\." src/systems/combat.rs` shows multiple config accesses
5. Running the simulation produces identical behavior to pre-config state
</verification>

<success_criteria>
- Zero behavioral const declarations remain in pheromone.rs, combat.rs, lifecycle.rs, movement.rs, dig.rs
- All 5 files access values through config.{subsystem}.{field}
- PheromoneGrid::decay_all accepts &PheromoneConfig
- PheromoneGrid::diffuse accepts &PheromoneConfig
- get_gradient_weighted accepts gradient_threshold parameter
- cargo build compiles cleanly
- Simulation behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-config-centralization/03-02-SUMMARY.md`
</output>
