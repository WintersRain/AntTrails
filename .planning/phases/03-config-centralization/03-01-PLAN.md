---
phase: 03-config-centralization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config.rs
  - src/main.rs
  - src/app.rs
autonomous: true

must_haves:
  truths:
    - "SimConfig struct exists with 9 nested sub-structs matching the research spec"
    - "App owns a SimConfig instance created via Default"
    - "Every system call in App::update() passes &self.config"
    - "Project compiles cleanly with cargo build"
  artifacts:
    - path: "src/config.rs"
      provides: "SimConfig + 9 sub-structs with Default impls"
      contains: "pub struct SimConfig"
    - path: "src/main.rs"
      provides: "Module declaration"
      contains: "mod config"
    - path: "src/app.rs"
      provides: "Config wiring through App"
      contains: "config: SimConfig"
  key_links:
    - from: "src/app.rs"
      to: "src/config.rs"
      via: "use crate::config::SimConfig"
      pattern: "use crate::config::SimConfig"
    - from: "src/app.rs"
      to: "system function calls"
      via: "&self.config passed to every system"
      pattern: "&self\\.config"
---

<objective>
Create the centralized SimConfig struct with all 9 sub-structs, wire it into App, and update every system function signature to accept &SimConfig -- establishing the config plumbing without changing any actual constant usage yet.

Purpose: After this plan, config flows through the entire system but existing constants still work. This avoids a half-compiled state where some functions expect config and others don't.
Output: src/config.rs (new), modified src/main.rs and src/app.rs. All systems accept &SimConfig but still use their own local constants internally.
</objective>

<execution_context>
@C:\Users\winte\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\winte\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@E:\VS Code Projects\AntTrails\.planning\PROJECT.md
@E:\VS Code Projects\AntTrails\.planning\ROADMAP.md
@E:\VS Code Projects\AntTrails\.planning\STATE.md
@E:\VS Code Projects\AntTrails\.planning\phases\03-config-centralization\03-RESEARCH.md
@E:\VS Code Projects\AntTrails\src\app.rs
@E:\VS Code Projects\AntTrails\src\main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config.rs with SimConfig and all sub-structs</name>
  <files>src/config.rs, src/main.rs</files>
  <action>
Create `src/config.rs` containing the complete SimConfig struct hierarchy as specified in the research document (03-RESEARCH.md, "Complete SimConfig Definition" section). This includes:

1. Top-level `SimConfig` with 9 pub fields: pheromone, combat, lifecycle, movement, food, spawn, colony, water, hazard
2. All 9 sub-structs: PheromoneConfig (13 fields), CombatConfig (14 fields), LifecycleConfig (11 fields), MovementConfig (9 fields), FoodConfig (8 fields), SpawnConfig (7 fields), ColonyConfig (1 field), WaterConfig (21 fields), HazardConfig (6 fields)
3. `impl Default` for every struct with EXACT values from the research inventory (these match current hardcoded values)
4. All structs derive `Clone, Debug` and all fields are `pub`

Add `mod config;` to `src/main.rs` (insert after the existing module declarations, before the `use` statement).

CRITICAL: Every default value must EXACTLY match the current hardcoded constant. Do not round, change types, or "improve" any value. This is a behavior-preserving refactoring. Copy values directly from the research inventory tables.
  </action>
  <verify>
Run `cargo check` from project root -- should pass (config.rs is defined but not yet used, no errors expected).
Verify config.rs contains all 9 sub-structs by searching for "impl Default for" -- should find 10 matches (SimConfig + 9 sub-structs).
  </verify>
  <done>src/config.rs exists with all 10 Default impls. main.rs has `mod config;`. `cargo check` passes.</done>
</task>

<task type="auto">
  <name>Task 2: Wire SimConfig into App and update all system call sites</name>
  <files>src/app.rs</files>
  <action>
Modify `src/app.rs` to:

1. Add import: `use crate::config::SimConfig;`

2. Add field to App struct: `config: SimConfig,`

3. In `App::new()`:
   - Create config: `let config = SimConfig::default();`
   - Replace `NUM_COLONIES` with `config.spawn.num_colonies` in spawn_colonies call
   - Replace `NUM_FOOD_SOURCES` with `config.food.num_food_sources` in spawn_food_sources call
   - Replace `NUM_APHIDS` with `config.spawn.num_aphids` in spawn_aphids call
   - Replace `NUM_WATER_SOURCES` with `config.water.num_water_sources` in spawn_water_sources call
   - Add `config` to the Self { ... } return struct
   - Remove the const declarations: `NUM_COLONIES`, `NUM_FOOD_SOURCES`, `NUM_APHIDS`, `NUM_WATER_SOURCES` (keep TARGET_FPS and FRAME_DURATION -- those are [LEAVE])

4. In `App::update()`:
   - Replace `self.tick % 10` (cave-in) with `self.tick % self.config.hazard.cave_in_interval`
   - Replace `self.tick % 3` (water flow) with `self.tick % self.config.water.water_flow_interval`
   - Replace `self.tick % 50` (evaporation) with `self.tick % self.config.water.evaporation_interval`
   - Pass `&self.config` to every system function call. The specific changes to each call site:
     - `systems::dig::dig_ai_system(&mut self.world, &self.terrain)` -> add `, &self.config`
     - `systems::combat::soldier_ai_system(...)` -> add `, &self.config`
     - `systems::combat::flee_system(...)` -> add `, &self.config`
     - `systems::movement::movement_system(...)` -> add `, &self.config`
     - `systems::dig::dig_system(...)` -> add `, &self.config`
     - `systems::food::foraging_system(...)` -> add `, &self.config`
     - `systems::food::check_deposit(...)` -> add `, &self.config`
     - `systems::combat::combat_system(...)` -> add `, &self.config`
     - `systems::aphid::aphid_system(...)` -> add `, &self.config`
     - `systems::pheromone::pheromone_decay_system(...)` -> add `, &self.config`
     - `self.pheromones.diffuse()` -> add `(&self.config.pheromone)` (PheromoneGrid method gets sub-config)
     - `systems::pheromone::pheromone_deposit_system(...)` -> add `, &self.config`
     - `systems::lifecycle::lifecycle_system(...)` -> add `, &self.config`
     - `systems::food::food_regrow_system(...)` -> add `, &self.config`
     - `systems::hazard::cave_in_system(...)` -> add `, &self.config`
     - `systems::water::calculate_pressure(...)` -- LEAVE as-is (no behavioral constants)
     - `systems::water::water_flow_system(...)` -- LEAVE as-is (no behavioral constants)
     - `systems::water::evaporation_system(...)` -> add `, &self.config`
     - `systems::water::rain_system(...)` -> add `, &self.config`
     - `systems::water::drowning_system(...)` -> add `, &self.config`
     - `systems::water::flee_flood_system(...)` -> add `, &self.config`
     - `systems::hazard::cleanup_dead(...)` -- LEAVE as-is (no behavioral constants)

5. For each system function that now receives `&self.config` but doesn't yet have the parameter in its definition, add `_config: &SimConfig` (with underscore prefix to suppress unused warnings) to the function signature. This means reading each system file and updating the pub fn signatures.

   Files and functions to update signatures (add `_config: &SimConfig` as last param):
   - src/systems/dig.rs: `dig_ai_system`, `dig_system`
   - src/systems/combat.rs: `soldier_ai_system`, `flee_system`, `combat_system`
   - src/systems/movement.rs: `movement_system`
   - src/systems/food.rs: `foraging_system`, `check_deposit`, `food_regrow_system`
   - src/systems/aphid.rs: `aphid_system`
   - src/systems/pheromone.rs: `pheromone_decay_system`, `pheromone_deposit_system`
   - src/systems/lifecycle.rs: `lifecycle_system`
   - src/systems/hazard.rs: `cave_in_system`
   - src/systems/water.rs: `evaporation_system`, `rain_system`, `drowning_system`, `flee_flood_system`
   - src/systems/pheromone.rs: PheromoneGrid::diffuse method (change to accept `_config: &PheromoneConfig`)

   Each file needs `use crate::config::SimConfig;` added to its imports (or `use crate::config::PheromoneConfig;` for pheromone.rs PheromoneGrid methods).

IMPORTANT: Use `_config` (underscored) for the parameter name in all system functions for now. Plans 02 and 03 will rename to `config` as they replace constants. This prevents unused-variable warnings.
  </action>
  <verify>
Run `cargo build` from project root -- must compile cleanly with zero errors and zero warnings about unused variables (underscore prefix handles this).
Run the simulation briefly (`cargo run`, let it run for 2-3 seconds, then Ctrl+C or press 'q') -- behavior must be identical to before (same values, just plumbed differently for the 4 app.rs constants that were already replaced).
  </verify>
  <done>App owns SimConfig. All system functions accept &SimConfig (underscored). All app.rs call sites pass &self.config. The 4 app.rs spawn constants and 3 tick-interval constants now use config. cargo build passes cleanly.</done>
</task>

</tasks>

<verification>
1. `cargo build` passes with zero errors
2. `cargo clippy` produces no new warnings related to config
3. `grep -r "pub fn.*_config.*SimConfig" src/systems/` shows all system functions accept the parameter
4. `grep "config:" src/app.rs` shows App struct has config field
5. Running the simulation produces identical behavior to pre-config state
</verification>

<success_criteria>
- src/config.rs exists with SimConfig + 9 sub-structs + 10 Default impls
- main.rs declares mod config
- App struct has config: SimConfig field
- Every system call in App::update() passes &self.config
- All system function signatures accept _config: &SimConfig
- cargo build compiles cleanly
- Simulation behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-config-centralization/03-01-SUMMARY.md`
</output>
