---
phase: 01-unfreeze-and-activate
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/systems/movement.rs
  - src/systems/dig.rs
autonomous: true

must_haves:
  truths:
    - "At any given moment, the majority of worker ants are visibly doing something (moving, digging, foraging) rather than sitting idle"
    - "Ants spend meaningful time in Wandering state before transitioning to Digging, allowing them to discover food and follow pheromone trails"
    - "Idle-to-Wandering transition is owned by one system (movement.rs), not fought over by two systems"
    - "The simulation does not oscillate -- ants do not flicker between states every frame"
  artifacts:
    - path: "src/systems/movement.rs"
      provides: "Increased Idle-to-Wandering probability (~30-40% per tick)"
      contains: "AntState::Idle"
    - path: "src/systems/dig.rs"
      provides: "Reduced Wandering-to-Digging probability (~20% per tick) and reduced/removed Idle transition"
      contains: "decide_worker_state"
  key_links:
    - from: "src/systems/movement.rs"
      to: "src/systems/dig.rs"
      via: "Idle-to-Wandering ownership consolidated in movement.rs; dig.rs no longer competes"
      pattern: "AntState::Idle"
---

<objective>
Tune activity probabilities so that the majority of ants are visibly active at any moment, and consolidate the Idle-to-Wandering transition to a single system.

Purpose: Even after wiring movement functions (Plan 01-01), ants spend 88-97% of ticks idle because the Idle-to-Wandering probability is only 3.9% per tick in movement.rs (and 11.7% in dig.rs). Additionally, the Wandering-to-Digging transition at 70.3% means ants that do start wandering immediately dig, leaving the surface empty. This plan tunes the probability system so ants feel alive.

Output: A simulation where >60% of worker ants are in active states (Wandering, Digging, Carrying, Returning, etc.) at any given tick, with smooth state transitions that do not oscillate.
</objective>

<execution_context>
@C:\Users\winte\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\winte\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-unfreeze-and-activate/01-01-SUMMARY.md
@src/systems/movement.rs
@src/systems/dig.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Increase Idle-to-Wandering probability in movement.rs and reduce in dig.rs</name>
  <files>src/systems/movement.rs, src/systems/dig.rs</files>
  <action>
  The goal is to make ~30-40% of idle ants start wandering each tick, owned by ONE system. Currently two systems compete:
  - `movement.rs` line 35: `fastrand::u8(..) < 10` = 3.9% (10/256)
  - `dig.rs` line 167: `fastrand::u8(..) < 30` = 11.7% (30/256)

  **In `src/systems/movement.rs`:**

  1. In the `AntState::Idle` match arm, change the threshold from `10` to `90`:
     ```rust
     AntState::Idle => {
         if fastrand::u8(..) < 90 {
             random_movement()
         } else {
             (0, 0)
         }
     }
     ```
     This gives ~35% chance per tick (90/256 = 35.2%). An idle ant will start moving within 2-3 ticks on average, which feels responsive without being frantic.

  **In `src/systems/dig.rs`:**

  2. In `decide_worker_state()`, in the `AntState::Idle` arm (line 165-171), reduce the threshold from `30` to `5`:
     ```rust
     AntState::Idle => {
         if fastrand::u8(..) < 5 {
             AntState::Wandering
         } else {
             AntState::Idle
         }
     }
     ```
     This reduces dig_ai's Idle-to-Wandering to ~2% (5/256), effectively making movement.rs the primary owner of this transition. The dig_ai still has a very small chance so ants occasionally start wandering from the dig system's perspective, but it no longer competes meaningfully.

     Why not remove it entirely? The dig_ai_system runs its own state machine and returning `AntState::Idle` unchanged is the safe no-op. Keeping a tiny probability preserves the code path without competing with movement.rs.

  **In `src/systems/dig.rs`:**

  3. In `decide_worker_state()`, in the `AntState::Wandering` arm (line 130-137), reduce the Wandering-to-Digging threshold from `180` to `50`:
     ```rust
     AntState::Wandering => {
         if can_dig && on_ground && fastrand::u8(..) < 50 {
             AntState::Digging
         } else {
             AntState::Wandering
         }
     }
     ```
     This reduces Wandering-to-Digging from 70.3% (180/256) to ~19.5% (50/256). An ant will now wander for an average of ~5 ticks before starting to dig, giving it time to encounter food sources, follow pheromone trails, and generally be visible on the surface.

     Why 50? At 50/256 = 19.5%, the average wandering time is ~5 ticks. This is enough for the foraging system (which runs every tick) to check if the ant is standing on food, and for the movement system's foraging_movement to steer the ant toward food pheromone trails. At the old 180/256, wandering lasted barely 1 tick.

  **Summary of probability changes:**

  | Transition | Old Value | New Value | Old % | New % |
  |------------|-----------|-----------|-------|-------|
  | Idle->Wandering (movement.rs) | 10 | 90 | 3.9% | 35.2% |
  | Idle->Wandering (dig.rs) | 30 | 5 | 11.7% | 2.0% |
  | Wandering->Digging (dig.rs) | 180 | 50 | 70.3% | 19.5% |
  </action>
  <verify>
  1. `cargo build` succeeds with no errors.
  2. `cargo run` -- visually confirm:
     - Ants on the surface are visibly moving (wandering) rather than sitting still
     - Ants take several ticks of wandering before they start digging
     - The surface is not empty -- ants are visible above ground
     - No rapid flickering between states (Idle->Wandering->Idle->Wandering)
  3. Verify the exact threshold values with grep:
     - `grep -n "fastrand::u8(..) < 90" src/systems/movement.rs` -- Idle threshold in movement
     - `grep -n "fastrand::u8(..) < 5" src/systems/dig.rs` -- Idle threshold in dig
     - `grep -n "fastrand::u8(..) < 50" src/systems/dig.rs` -- Wandering-to-Digging threshold

  Note: Visual confirmation (`cargo run` to observe ant liveliness) is useful but not required for task completion. The verify criteria above are automatable. If values need further tuning based on visual observation, that is a future iteration concern.
  </verify>
  <done>
  Idle-to-Wandering probability is ~35% per tick (owned by movement.rs). Dig.rs Idle-to-Wandering reduced to ~2% (no longer competing). Wandering-to-Digging reduced from ~70% to ~20% so ants actually wander before digging. `cargo build` succeeds. Visually, the majority of ants are active at any given moment.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` completes with zero errors
2. `cargo run` shows majority of ants actively moving/working at any moment
3. Idle-to-Wandering in movement.rs: threshold ~90 (adjustable)
4. Idle-to-Wandering in dig.rs: threshold ~5 (reduced from 30)
5. Wandering-to-Digging in dig.rs: threshold ~50 (reduced from 180)
6. No state oscillation visible (ants don't flicker between states)
</verification>

<success_criteria>
- At any given moment, >60% of worker ants are in a non-Idle state
- Ants spend multiple ticks wandering before transitioning to dig
- Idle-to-Wandering transition is effectively owned by movement.rs
- The simulation feels alive -- surfaces have moving ants, not frozen dots
- No regression: carrying, fighting, fleeing ants still move correctly (from Plan 01-01)
</success_criteria>

<output>
After completion, create `.planning/phases/01-unfreeze-and-activate/01-02-SUMMARY.md`
</output>
