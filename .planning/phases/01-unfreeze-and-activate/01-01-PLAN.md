---
phase: 01-unfreeze-and-activate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/systems/movement.rs
  - src/app.rs
  - src/systems/food.rs
  - src/systems/combat.rs
autonomous: true

must_haves:
  truths:
    - "Ants in Carrying state move toward their colony home position instead of freezing at food pickup location"
    - "Ants in Fighting state move toward danger pheromone sources instead of freezing at (0,0)"
    - "Ants in Fleeing state move away from danger instead of freezing at (0,0)"
    - "Ants in Following state follow food pheromone trails instead of freezing at (0,0)"
    - "No AntState variant hits a wildcard match arm -- every state is explicitly handled"
  artifacts:
    - path: "src/systems/movement.rs"
      provides: "Expanded movement_system with explicit match arms for all 8 AntState variants"
      contains: "AntState::Carrying"
    - path: "src/app.rs"
      provides: "Updated movement_system call site with pheromones and colonies arguments"
      contains: "movement_system"
  key_links:
    - from: "src/systems/movement.rs"
      to: "src/systems/food.rs::foraging_movement"
      via: "AntState::Carrying and AntState::Following match arms"
      pattern: "food::foraging_movement"
    - from: "src/systems/movement.rs"
      to: "src/systems/combat.rs::fighting_movement"
      via: "AntState::Fighting match arm"
      pattern: "combat::fighting_movement"
    - from: "src/systems/movement.rs"
      to: "src/systems/combat.rs::fleeing_movement"
      via: "AntState::Fleeing match arm"
      pattern: "combat::fleeing_movement"
    - from: "src/app.rs"
      to: "src/systems/movement.rs::movement_system"
      via: "Updated call with 4 arguments"
      pattern: "movement_system.*pheromones.*colonies"
---

<objective>
Wire orphaned movement functions into the movement system and eliminate the wildcard `_ => (0, 0)` match that freezes ants in Carrying, Fighting, Following, and Fleeing states.

Purpose: This is the highest-impact fix in the project. Ants in active behavioral states (carrying food home, fighting enemies, fleeing danger) currently freeze in place because the movement system's wildcard catch-all returns zero movement for any state it doesn't explicitly handle. The correct movement logic already exists in `food.rs` and `combat.rs` -- it just needs to be called.

Output: A movement system that delegates to domain-specific movement functions for every AntState variant, with no wildcards. Carrying ants walk home, fighting ants pursue danger, fleeing ants escape, following ants track food pheromone trails.
</objective>

<execution_context>
@C:\Users\winte\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\winte\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/systems/movement.rs
@src/systems/food.rs
@src/systems/combat.rs
@src/app.rs
@src/components.rs
@src/systems/spawn.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand movement_system signature and wire all AntState match arms</name>
  <files>src/systems/movement.rs, src/app.rs</files>
  <action>
  **In `src/systems/movement.rs`:**

  1. Add these imports at the top of the file (alongside existing imports):
     ```rust
     use crate::colony::ColonyState;
     use crate::components::{Ant, AntRole, AntState, ColonyMember, Position};
     use crate::systems::pheromone::PheromoneGrid;
     use crate::terrain::{Terrain, TerrainType};
     ```
     Note: `Ant`, `AntRole`, `AntState`, `Position` are already imported. Add `ColonyMember`, `ColonyState`, and `PheromoneGrid`. Keep existing `TerrainType` import.

  2. Change the `movement_system` function signature from:
     ```rust
     pub fn movement_system(world: &mut World, terrain: &Terrain)
     ```
     to:
     ```rust
     pub fn movement_system(
         world: &mut World,
         terrain: &Terrain,
         pheromones: &PheromoneGrid,
         colonies: &[ColonyState],
     )
     ```

  3. Change the ECS query from `world.query::<(&Position, &Ant)>()` to `world.query::<(&Position, &Ant, &ColonyMember)>()`. Update the destructuring: `for (entity, (pos, ant, member)) in ...`.

     IMPORTANT: All ants are spawned with `ColonyMember` (verified in spawn.rs:110-114), so this query will not exclude any ants. But be aware that hecs queries are conjunctive -- adding a component narrows results.

  4. Replace the entire match block (lines 23-42) with explicit arms for ALL 8 AntState variants. The key changes:

     ```rust
     let (dx, dy) = match ant.state {
         AntState::Wandering => random_movement(),
         AntState::Digging => dig_movement(pos, terrain),
         AntState::Returning => climb_movement(pos, terrain),
         AntState::Idle => {
             if fastrand::u8(..) < 10 {
                 random_movement()
             } else {
                 (0, 0)
             }
         }
         AntState::Carrying => {
             match crate::systems::food::foraging_movement(
                 pos, ant, member, terrain, pheromones, colonies
             ) {
                 Some(dir) => dir,
                 None => random_movement(),
             }
         }
         AntState::Fighting => {
             match crate::systems::combat::fighting_movement(pos, member, pheromones) {
                 Some(dir) => dir,
                 None => random_movement(),
             }
         }
         AntState::Fleeing => {
             match crate::systems::combat::fleeing_movement(pos, pheromones) {
                 Some(dir) => dir,
                 None => random_movement(),
             }
         }
         AntState::Following => {
             match crate::systems::food::foraging_movement(
                 pos, ant, member, terrain, pheromones, colonies
             ) {
                 Some(dir) => dir,
                 None => random_movement(),
             }
         }
     };
     ```

     CRITICAL: The orphaned functions return `Option<(i32, i32)>`. When they return `None` (no gradient, no path), fall back to `random_movement()`, NOT `(0, 0)`. A confused ant should wander randomly, not freeze. This matches real ant behavior.

     CRITICAL: Do NOT use `_ => ...` wildcard. Every variant must be listed explicitly so Rust's exhaustive match checking will catch any future additions to the AntState enum.

  **In `src/app.rs`:**

  5. Update the movement_system call site (line 162) from:
     ```rust
     systems::movement::movement_system(&mut self.world, &self.terrain);
     ```
     to:
     ```rust
     systems::movement::movement_system(
         &mut self.world,
         &self.terrain,
         &self.pheromones,
         &self.colonies,
     );
     ```

     Note: `self.pheromones` is `PheromoneGrid` and `self.colonies` is `Vec<ColonyState>`. The function expects `&[ColonyState]` which Rust will auto-deref from `&Vec<ColonyState>`.
  </action>
  <verify>
  Run `cargo build` from the project root. The build must succeed with zero errors. Specifically verify:
  - No "expected 2 arguments, found 4" error (call site updated)
  - No "unused import" warnings for `ColonyMember`, `PheromoneGrid`, `ColonyState`
  - No "unreachable pattern" warnings (no duplicate match arms)
  - The `_ => (0, 0)` wildcard is gone from movement.rs
  </verify>
  <done>
  All 8 AntState variants have explicit match arms in movement_system. The wildcard `_ => (0, 0)` is eliminated. The movement_system signature accepts pheromones and colonies. The call site in app.rs passes the new arguments. `cargo build` succeeds cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove dead_code suppression from food.rs and combat.rs</name>
  <files>src/systems/food.rs, src/systems/combat.rs</files>
  <action>
  Now that `foraging_movement`, `fighting_movement`, and `fleeing_movement` are called from the movement system, the `#![allow(dead_code)]` attributes that suppressed warnings about them being unused are no longer needed.

  1. **In `src/systems/food.rs`:** Remove the `#![allow(dead_code)]` at line 1. This was suppressing the warning that `foraging_movement()` was never called. It is now called.

  2. **In `src/systems/combat.rs`:** Remove the `#![allow(dead_code)]` at line 1. This was suppressing the warning that `fighting_movement()` and `fleeing_movement()` were never called. They are now called.

  3. After removing both attributes, check for any remaining dead_code warnings. If there are other unused functions in these files, do NOT re-add the blanket `#![allow(dead_code)]`. Instead, add targeted `#[allow(dead_code)]` on the specific unused items, or leave the warnings visible so future phases can address them.

  Why: `#![allow(dead_code)]` at module level silences ALL dead code warnings in the file, hiding potentially disconnected code. Now that the primary orphaned functions are wired, we want the compiler to tell us about any remaining disconnected code.
  </action>
  <verify>
  Run `cargo build` from the project root. Check the output for:
  - No errors
  - If any new dead_code warnings appear (for functions OTHER than the three we wired), note them but do not suppress them. These are informational for future phases.
  - The three wired functions (`foraging_movement`, `fighting_movement`, `fleeing_movement`) should NOT produce dead_code warnings since they are now called.
  </verify>
  <done>
  `#![allow(dead_code)]` removed from both `food.rs` and `combat.rs`. The three previously-orphaned movement functions no longer trigger dead_code warnings because they are wired into the movement system. Any remaining dead_code warnings are left visible for future cleanup. `cargo build` succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` completes with zero errors
2. `grep -n "_ =>" src/systems/movement.rs` returns zero results (no wildcard matches on AntState)
3. `grep -n "AntState::Carrying\|AntState::Fighting\|AntState::Fleeing\|AntState::Following" src/systems/movement.rs` returns 4 lines (one for each explicit match arm)
4. `grep -rn "foraging_movement\|fighting_movement\|fleeing_movement" src/systems/movement.rs` returns 3+ lines (the functions are called)
5. `grep -n "#!\[allow(dead_code)\]" src/systems/food.rs src/systems/combat.rs` returns zero results
6. `cargo run` launches the simulation and ants in Carrying state visibly move toward their colony home (requires visual observation)
</verification>

<success_criteria>
- Every AntState variant has an explicit movement match arm -- no wildcards
- Carrying ants call `foraging_movement()` which directs them toward colony home
- Fighting ants call `fighting_movement()` which follows danger pheromone gradients
- Fleeing ants call `fleeing_movement()` which moves away from danger
- Following ants call `foraging_movement()` which follows food pheromone trails
- All None returns from delegated functions fall back to `random_movement()`, not `(0, 0)`
- The code compiles cleanly with `cargo build`
</success_criteria>

<output>
After completion, create `.planning/phases/01-unfreeze-and-activate/01-01-SUMMARY.md`
</output>
